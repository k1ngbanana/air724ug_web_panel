import { defineMock } from 'vite-plugin-mock-dev-server'
import { builder } from '../util'

// å­˜å‚¨æ³¨å†Œçš„ç”¨æˆ·ï¼ˆæ¨¡æ‹Ÿæ•°æ®åº“ï¼‰
const registeredUsers: Record<string, { password: string; role: string; uid: number; email?: string; needActivation: boolean; createdAt: string; status: string }> = {
  'admin': { password: 'admin123', role: 'admin', uid: 1, needActivation: false, createdAt: '2024-01-01T00:00:00.000Z', status: 'active' },
  'user1': { password: 'user123', role: 'user', uid: 2, needActivation: false, email: 'user1@example.com', createdAt: '2024-02-15T10:30:00.000Z', status: 'active' },
  'user2': { password: 'user123', role: 'user', uid: 3, needActivation: false, email: 'user2@example.com', createdAt: '2024-03-20T14:20:00.000Z', status: 'active' },
  'testuser': { password: 'test123', role: 'user', uid: 4, needActivation: false, email: 'test@example.com', createdAt: '2024-10-01T08:15:00.000Z', status: 'active' },
  '123456': { password: '123456', role: 'user', uid: 100, needActivation: false, email: '', createdAt: '2024-11-09T14:20:00.000Z', status: 'active' },
}

let nextUserId = 101 // æ–°æ³¨å†Œç”¨æˆ·çš„èµ·å§‹ID

// å­˜å‚¨æ¿€æ´»ç ï¼ˆæ¨¡æ‹Ÿæ•°æ®åº“ï¼‰
const activationKeys: Array<{
  _id: string
  code: string
  description: string
  createdAt: string
  expiresAt?: string
  status: string
  maxUses: number
  usedCount: number
  usedBy?: string
  usedAt?: string
}> = [
  {
    _id: 'key1',
    code: 'ACTIVATE-2024-A1B2C3D4',
    description: '2024å¹´11æœˆæ‰¹æ¬¡',
    createdAt: '2024-11-01T10:00:00.000Z',
    expiresAt: '2025-11-01T10:00:00.000Z',
    status: 'active',
    maxUses: 10,
    usedCount: 3,
    usedBy: 'user1',
    usedAt: '2024-11-05T14:30:00.000Z',
  },
  {
    _id: 'key2',
    code: 'ACTIVATE-2024-E5F6G7H8',
    description: 'æµ‹è¯•ç”¨æ¿€æ´»ç ',
    createdAt: '2024-10-15T14:30:00.000Z',
    expiresAt: '2024-12-31T23:59:59.000Z',
    status: 'active',
    maxUses: 1,
    usedCount: 0,
  },
  {
    _id: 'key3',
    code: 'ACTIVATE-2024-I9J0K1L2',
    description: 'å·²ç¦ç”¨çš„æ¿€æ´»ç ',
    createdAt: '2024-09-20T09:15:00.000Z',
    status: 'disabled',
    maxUses: 5,
    usedCount: 5,
    usedBy: 'user2',
    usedAt: '2024-10-01T08:20:00.000Z',
  },
]

// è®¾å¤‡åˆ—è¡¨ï¼ˆç­‰å¾…WebSocketè¿æ¥çš„çœŸå®è®¾å¤‡ï¼‰
const devices: Array<{
  imei: string
  phone: string
  connected: boolean
  lastSeen: number
  iccid?: string
  signal?: number
  operator?: string
  owner: string
}> = []

// ç”¨äºå­˜å‚¨tokenå’Œç”¨æˆ·åçš„æ˜ å°„ï¼ˆæ¨¡æ‹ŸJWTè§£æï¼‰
const tokenUserMap: Record<string, string> = {}

export default defineMock([
  {
    url: '/api/auth/login',
    delay: 500,
    body: ({ body }) => {
      const { username, password } = body
      
      // ä½¿ç”¨æ³¨å†Œç”¨æˆ·åˆ—è¡¨éªŒè¯
      const validUsers = registeredUsers
      
      // éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
      if (validUsers[username] && validUsers[username].password === password) {
        const user = validUsers[username]
        const token = `mock-${user.role}-token-` + Date.now()
        
        // ä¿å­˜tokenå’Œç”¨æˆ·åçš„æ˜ å°„
        tokenUserMap[token] = username
        console.log('ç”¨æˆ·ç™»å½•:', username, 'Token:', token.substring(0, 30) + '...')
        
        return {
          code: 0,
          data: {
            token: token,
            user: {
              uid: user.uid,
              username: username,
              name: username,
              role: user.role,
              status: user.needActivation ? 'inactive' : 'active',
              needActivation: user.needActivation,
              email: user.email,
              avatar: user.role === 'admin' ? 'https://iconfont.alicdn.com/p/user/eZQFvSX6g8f1/f0d9fd95-a5f0-474d-98b0-d51e8450f2cf.png' : undefined,
            },
          },
          msg: 'ç™»å½•æˆåŠŸ',
        }
      } else {
        return {
          code: 1,
          msg: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯',
        }
      }
    },
  },
  {
    url: '/api/user/me',
    delay: 100,
    body: () => {
      return {
        code: 0,
        data: {
          uid: 1,
          name: 'admin',
          avatar: 'https://iconfont.alicdn.com/p/user/eZQFvSX6g8f1/f0d9fd95-a5f0-474d-98b0-d51e8450f2cf.png',
        },
        msg: 'success',
      }
    },
  },
  {
    url: '/api/userPool',
    delay: 300,
    body: ({ headers }) => {
      // ä»è¯·æ±‚å¤´è·å–token
      const token = headers?.authorization?.replace('Bearer ', '') || ''
      
      console.log('========== è·å–è®¾å¤‡åˆ—è¡¨ ==========')
      console.log('Token:', token)
      console.log('TokenUserMap:', tokenUserMap)
      
      // ä»tokenUserMapè·å–ç”¨æˆ·åï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œå°è¯•ä»tokenä¸­è§£æ
      let currentUser = tokenUserMap[token] || ''
      let isAdmin = false
      
      // å¦‚æœtokenUserMapä¸­æ²¡æœ‰ï¼Œå°è¯•ä»tokenä¸­è§£æï¼ˆå…¼å®¹æœåŠ¡å™¨é‡å¯çš„æƒ…å†µï¼‰
      if (!currentUser && token) {
        if (token.includes('admin-token')) {
          currentUser = 'admin'
          isAdmin = true
          // é‡æ–°ä¿å­˜æ˜ å°„
          tokenUserMap[token] = 'admin'
          console.log('âš ï¸ ä»tokenæ¢å¤ç®¡ç†å‘˜èº«ä»½')
        } else if (token.includes('user-token')) {
          // æ™®é€šç”¨æˆ·æ— æ³•ä»tokenæ¢å¤èº«ä»½ï¼Œè¿”å›ç©ºåˆ—è¡¨
          console.log('âš ï¸ æ— æ³•ä»tokenæ¢å¤ç”¨æˆ·èº«ä»½ï¼Œè¯·é‡æ–°ç™»å½•')
          return []
        }
      } else {
        isAdmin = currentUser === 'admin'
      }
      
      console.log('å½“å‰ç”¨æˆ·:', currentUser, 'æ˜¯å¦ç®¡ç†å‘˜:', isAdmin)
      console.log('æ‰€æœ‰è®¾å¤‡:', devices.map(d => ({ imei: d.imei, owner: d.owner })))
      
      // ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰è®¾å¤‡ï¼ˆåŒ…æ‹¬ownerä¿¡æ¯ï¼‰
      if (isAdmin) {
        console.log('âœ… ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰è®¾å¤‡:', devices.length, 'ä¸ª')
        const result = devices.map(device => ({
          ...device,
          boundUser: device.owner || 'æœªç»‘å®š' // æ·»åŠ ç»‘å®šç”¨æˆ·å­—æ®µ
        }))
        console.log('è¿”å›è®¾å¤‡æ•°é‡:', result.length)
        return result
      }
      
      // æ™®é€šç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±ç»‘å®šçš„è®¾å¤‡ï¼ˆowner === currentUser ä¸”ä¸ä¸ºç©ºï¼‰
      const userDevices = devices.filter(device => device.owner === currentUser && device.owner !== '')
      console.log(`ğŸ‘¤ ç”¨æˆ· ${currentUser || 'æœªçŸ¥ç”¨æˆ·'} çš„è®¾å¤‡æ•°é‡:`, userDevices.length, 'ä¸ª')
      console.log('è¿”å›çš„è®¾å¤‡IMEI:', userDevices.map(d => d.imei))
      
      // è¿”å›è®¾å¤‡åˆ—è¡¨ï¼ˆç§»é™¤ownerå­—æ®µï¼‰
      return userDevices.map(({ owner, ...device }) => device)
    },
  },
  {
    url: '/api/user/logout',
    delay: 500,
    body: () => {
      return {
        code: 0,
        msg: 'success',
      }
    },
  },
  {
    url: '/api/device/unbind',
    method: 'POST',
    delay: 500,
    body: ({ body, headers }) => {
      const { imei } = body
      const token = headers?.authorization?.replace('Bearer ', '') || ''
      
      if (!imei) {
        return {
          code: 1,
          msg: 'è¯·è¾“å…¥è®¾å¤‡IMEI',
        }
      }
      
      // ä»tokenè·å–ç”¨æˆ·å
      const currentUser = tokenUserMap[token] || ''
      
      if (!currentUser) {
        return {
          code: 1,
          msg: 'è¯·å…ˆç™»å½•',
        }
      }
      
      // æŸ¥æ‰¾è®¾å¤‡
      const device = devices.find(d => d.imei === imei)
      
      if (!device) {
        return {
          code: 1,
          msg: 'è®¾å¤‡ä¸å­˜åœ¨',
        }
      }
      
      if (device.owner !== currentUser) {
        return {
          code: 1,
          msg: 'åªèƒ½è§£ç»‘è‡ªå·±çš„è®¾å¤‡',
        }
      }
      
      // è§£ç»‘è®¾å¤‡
      device.owner = ''
      console.log(`è®¾å¤‡ ${imei} å·²ä»ç”¨æˆ· ${currentUser} è§£ç»‘`)
      
      return {
        code: 0,
        msg: 'è®¾å¤‡è§£ç»‘æˆåŠŸ',
      }
    },
  },
  {
    url: '/api/device/bind',
    method: 'POST',
    delay: 500,
    body: ({ body, headers }) => {
      const { imei } = body
      const token = headers?.authorization?.replace('Bearer ', '') || ''
      
      if (!imei) {
        return {
          code: 1,
          msg: 'è¯·è¾“å…¥è®¾å¤‡IMEI',
        }
      }
      
      // ä»tokenè·å–ç”¨æˆ·å
      const currentUser = tokenUserMap[token] || ''
      
      if (!currentUser) {
        return {
          code: 1,
          msg: 'è¯·å…ˆç™»å½•',
        }
      }
      
      // ç®¡ç†å‘˜ä¸èƒ½ç»‘å®šè®¾å¤‡
      if (currentUser === 'admin') {
        return {
          code: 1,
          msg: 'ç®¡ç†å‘˜æ— éœ€ç»‘å®šè®¾å¤‡',
        }
      }
      
      // æŸ¥æ‰¾è®¾å¤‡
      const device = devices.find(d => d.imei === imei)
      
      if (!device) {
        return {
          code: 1,
          msg: 'è®¾å¤‡ä¸å­˜åœ¨',
        }
      }
      
      if (device.owner && device.owner !== '') {
        return {
          code: 1,
          msg: `è¯¥è®¾å¤‡å·²è¢«ç”¨æˆ· ${device.owner} ç»‘å®š`,
        }
      }
      
      // ç»‘å®šè®¾å¤‡åˆ°å½“å‰ç”¨æˆ·
      device.owner = currentUser
      console.log(`è®¾å¤‡ ${imei} å·²ç»‘å®šåˆ°ç”¨æˆ· ${currentUser}`)
      
      return {
        code: 0,
        data: {
          imei: device.imei,
          phone: device.phone,
          operator: device.operator,
        },
        msg: 'è®¾å¤‡ç»‘å®šæˆåŠŸ',
      }
    },
  },
  {
    url: '/api/user/email-code',
    delay: 1000,
    body: () => {
      const code = '123456'
      return builder(code)
    },
  },
  {
    url: '/api/user/reset-password',
    delay: 1000,
    body: () => {
      const res = true
      return builder(res)
    },
  },
  {
    url: '/api/user/register',
    delay: 1000,
    body: () => {
      const res = true
      return builder(res)
    },
  },
  {
    url: '/api/auth/register',
    delay: 500,
    body: ({ body }) => {
      const { username, password, email } = body
      
      if (!username || !password) {
        return {
          code: 1,
          msg: 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º',
        }
      }
      
      // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
      if (registeredUsers[username]) {
        return {
          code: 1,
          msg: 'ç”¨æˆ·åå·²å­˜åœ¨',
        }
      }
      
      // æ·»åŠ æ–°ç”¨æˆ·åˆ°æ³¨å†Œåˆ—è¡¨
      registeredUsers[username] = {
        password: password,
        role: 'user',
        uid: nextUserId++,
        email: email,
        needActivation: true, // æ–°æ³¨å†Œç”¨æˆ·éœ€è¦æ¿€æ´»
        createdAt: new Date().toISOString(),
        status: 'inactive',
      }
      
      console.log('æ–°ç”¨æˆ·æ³¨å†ŒæˆåŠŸ:', username, 'å½“å‰ç”¨æˆ·åˆ—è¡¨:', Object.keys(registeredUsers))
      
      // æ¨¡æ‹Ÿæ³¨å†ŒæˆåŠŸ
      return {
        code: 0,
        data: {
          username: username,
          email: email,
        },
        msg: 'æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•åä½¿ç”¨æ¿€æ´»ç æ¿€æ´»è´¦å·',
      }
    },
  },
  {
    url: '/api/auth/activate',
    delay: 500,
    body: ({ body }) => {
      const { activationCode } = body
      
      // æ¨¡æ‹Ÿæ¿€æ´»ç éªŒè¯ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥éªŒè¯æ¿€æ´»ç æ˜¯å¦æœ‰æ•ˆï¼‰
      if (activationCode && activationCode.length >= 8) {
        // è·å–å½“å‰ç™»å½•ç”¨æˆ·ï¼ˆä»tokenæˆ–è¯·æ±‚å¤´ä¸­è·å–ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
        // å®é™…åº”è¯¥ä»è¯·æ±‚å¤´çš„Authorizationä¸­è§£æç”¨æˆ·
        // è¿™é‡Œæˆ‘ä»¬å‡è®¾æ¿€æ´»çš„æ˜¯æœ€åæ³¨å†Œçš„ç”¨æˆ·
        
        // å°†æ‰€æœ‰éœ€è¦æ¿€æ´»çš„ç”¨æˆ·éƒ½æ¿€æ´»ï¼ˆç®€åŒ–å¤„ç†ï¼‰
        Object.keys(registeredUsers).forEach(username => {
          if (registeredUsers[username].needActivation) {
            registeredUsers[username].needActivation = false
            console.log('ç”¨æˆ·æ¿€æ´»æˆåŠŸ:', username)
          }
        })
        
        return {
          code: 0,
          data: {
            status: 'active',
          },
          msg: 'æ¿€æ´»æˆåŠŸ',
        }
      } else {
        return {
          code: 1,
          msg: 'æ¿€æ´»ç æ— æ•ˆæˆ–æ ¼å¼ä¸æ­£ç¡®',
        }
      }
    },
  },
  {
    url: '/api/admin/users',
    method: 'GET',
    delay: 300,
    body: () => {
      // è¿”å›ç”¨æˆ·åˆ—è¡¨ï¼ˆä¸åŒ…å«å½“å‰ç™»å½•çš„adminï¼Œé¿å…è‡ªå·±ç®¡ç†è‡ªå·±ï¼‰
      // ä»registeredUsersåŠ¨æ€ç”Ÿæˆåˆ—è¡¨
      const allUsers = Object.keys(registeredUsers)
      console.log('è·å–ç”¨æˆ·åˆ—è¡¨ï¼Œæ€»ç”¨æˆ·æ•°:', allUsers.length, 'ç”¨æˆ·åˆ—è¡¨:', allUsers)
      
      const userList = allUsers
        .filter(username => username !== 'admin') // æ’é™¤admin
        .map(username => {
          const user = registeredUsers[username]
          return {
            _id: user.uid.toString(),
            username: username,
            email: user.email || '',
            role: user.role,
            status: user.status,
            createdAt: user.createdAt,
            metadata: {
              lastLogin: new Date(Date.now() - Math.random() * 86400000).toISOString(),
              loginCount: Math.floor(Math.random() * 100),
            },
          }
        })
      
      console.log('è¿”å›ç”¨æˆ·åˆ—è¡¨ï¼ˆä¸å«adminï¼‰:', userList.length, 'ä¸ªç”¨æˆ·')
      
      return {
        success: true,
        data: userList,
      }
    },
  },
  {
    url: '/api/admin/users',
    method: 'POST',
    delay: 500,
    body: ({ body }) => {
      const { username, password, email, role } = body
      
      if (!username || !password) {
        return {
          success: false,
          message: 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º',
        }
      }
      
      // æ¨¡æ‹Ÿæ·»åŠ ç”¨æˆ·æˆåŠŸ
      return {
        success: true,
        data: {
          _id: Date.now().toString(),
          username: username,
          email: email || '',
          role: role || 'user',
          status: 'active',
          createdAt: new Date().toISOString(),
        },
        message: 'æ·»åŠ ç”¨æˆ·æˆåŠŸ',
      }
    },
  },
  {
    url: '/api/admin/users/:userId',
    method: 'DELETE',
    delay: 500,
    body: () => {
      // æ¨¡æ‹Ÿåˆ é™¤ç”¨æˆ·æˆåŠŸ
      return {
        success: true,
        message: 'åˆ é™¤ç”¨æˆ·æˆåŠŸ',
      }
    },
  },
  {
    url: '/api/admin/users/:userId/status',
    method: 'PUT',
    delay: 500,
    body: ({ body }) => {
      const { status } = body
      
      // æ¨¡æ‹Ÿæ›´æ–°ç”¨æˆ·çŠ¶æ€æˆåŠŸ
      return {
        success: true,
        data: {
          status: status,
        },
        message: 'æ›´æ–°çŠ¶æ€æˆåŠŸ',
      }
    },
  },
  {
    url: '/api/admin/activation-keys',
    method: 'GET',
    delay: 300,
    body: () => {
      // è¿”å›æ¿€æ´»ç åˆ—è¡¨ï¼ˆä»å…¨å±€å­˜å‚¨è¯»å–ï¼‰
      return {
        success: true,
        data: activationKeys,
      }
    },
  },
  {
    url: '/api/admin/activation-keys',
    method: 'POST',
    delay: 500,
    body: ({ body }) => {
      const { description, expiresIn, maxUses } = body
      
      if (!description) {
        return {
          success: false,
          message: 'è¯·å¡«å†™æ¿€æ´»ç æè¿°',
        }
      }
      
      // ç”Ÿæˆéšæœºæ¿€æ´»ç 
      const randomCode = 'ACTIVATE-' + new Date().getFullYear() + '-' + 
        Math.random().toString(36).substring(2, 6).toUpperCase() + 
        Math.random().toString(36).substring(2, 6).toUpperCase()
      
      const expiresAt = expiresIn > 0 ? new Date(Date.now() + expiresIn * 24 * 60 * 60 * 1000).toISOString() : undefined
      
      // åˆ›å»ºæ–°æ¿€æ´»ç 
      const newKey = {
        _id: Date.now().toString(),
        code: randomCode,
        description: description,
        createdAt: new Date().toISOString(),
        expiresAt: expiresAt,
        status: 'active',
        maxUses: maxUses || 1,
        usedCount: 0,
      }
      
      // æ·»åŠ åˆ°æ¿€æ´»ç åˆ—è¡¨
      activationKeys.push(newKey)
      
      console.log('æ–°æ¿€æ´»ç ç”Ÿæˆ:', randomCode, 'å½“å‰æ¿€æ´»ç æ•°é‡:', activationKeys.length)
      
      // æ¨¡æ‹Ÿç”Ÿæˆæ¿€æ´»ç æˆåŠŸ
      return {
        success: true,
        data: newKey,
        message: 'æ¿€æ´»ç ç”ŸæˆæˆåŠŸ',
      }
    },
  },
  {
    url: '/api/admin/activation-keys/:keyId',
    method: 'DELETE',
    delay: 500,
    body: () => {
      // æ¨¡æ‹Ÿåˆ é™¤æ¿€æ´»ç æˆåŠŸ
      return {
        success: true,
        message: 'åˆ é™¤æ¿€æ´»ç æˆåŠŸ',
      }
    },
  },
  {
    url: '/api/admin/activation-keys/:keyId/status',
    method: 'PATCH',
    delay: 500,
    body: ({ body }) => {
      const { status } = body
      
      // æ¨¡æ‹Ÿæ›´æ–°æ¿€æ´»ç çŠ¶æ€æˆåŠŸ
      return {
        success: true,
        data: {
          status: status,
        },
        message: 'æ›´æ–°çŠ¶æ€æˆåŠŸ',
      }
    },
  },
  {
    url: '/api/admin/account/update',
    method: 'POST',
    delay: 500,
    body: ({ body, headers }) => {
      const { currentPassword, newPassword, email } = body
      const token = headers?.authorization?.replace('Bearer ', '') || ''
      
      // ä»tokenè·å–å½“å‰ç”¨æˆ·
      const currentUser = tokenUserMap[token] || 'admin'
      
      if (!registeredUsers[currentUser]) {
        return {
          success: false,
          message: 'ç”¨æˆ·ä¸å­˜åœ¨',
        }
      }
      
      // å¦‚æœè¦ä¿®æ”¹å¯†ç ï¼ŒéªŒè¯å½“å‰å¯†ç 
      if (newPassword) {
        if (!currentPassword) {
          return {
            success: false,
            message: 'è¯·è¾“å…¥å½“å‰å¯†ç ',
          }
        }
        
        if (registeredUsers[currentUser].password !== currentPassword) {
          return {
            success: false,
            message: 'å½“å‰å¯†ç é”™è¯¯',
          }
        }
        
        // æ›´æ–°å¯†ç 
        registeredUsers[currentUser].password = newPassword
        console.log(`ç”¨æˆ· ${currentUser} å¯†ç å·²æ›´æ–°`)
      }
      
      // æ›´æ–°é‚®ç®±
      if (email !== undefined) {
        registeredUsers[currentUser].email = email
        console.log(`ç”¨æˆ· ${currentUser} é‚®ç®±å·²æ›´æ–°ä¸º: ${email}`)
      }
      
      // è¿”å›æ›´æ–°åçš„ä¿¡æ¯
      return {
        success: true,
        data: {
          email: registeredUsers[currentUser].email,
        },
        message: 'ä¿å­˜æˆåŠŸ',
      }
    },
  },
])
